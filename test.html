<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Document</title>
    <link rel="stylesheet" href="./style/style_chat.css" />
    <link rel="stylesheet" href="./style/style_chat_dialog.css" />
    <link rel="stylesheet" href="./style/style_icons_and_fonts.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>

  <body>
    <div id="dialog" class="dialog">
      <div class="dialog__wrapper">
        <div class="message message__self">
          <div class="message__photo">
            <img src="./image/user.png" alt="profile" class="message__img" />
          </div>
          <div class="message__card message__card--self">
            <div class="dialog__message--voice">
              <div class="dialog__message--voice-control">
                <button
                  onclick="startPlaying()"
                  id="playerButton"
                  class="dialog__message--playe"
                ></button>
                <!-- <button id="pauseButton" class="dialog__message--pause"></button> -->
              </div>
              <div class="dialog__message--voice-Wave">
                <div id="playeButton" class="dialog__message--play">hii</div>
              </div>
              <div id="voiceDownload" class="dialog__message--voice-download">

              </div>
            </div>
          </div>
        </div>
        <button id="recordButton" class="dialog__voice">ضبط</button>
        <button id="saveButton" class="dialog__voice">ذخیره</button>
      </div>
    </div>

    <script>

      startPlaying=()=>{
      const playerButton = document.getElementById("playerButton");
      playerButton.style="transition: all 2s;"
      if(playerButton.classList[0] === "dialog__message--pause"){
        playerButton.setAttribute("class","dialog__message--playe")
      }
      else{
        playerButton.setAttribute("class","dialog__message--pause")
      }

      }

      const recordButton = document.querySelector("#recordButton");
      recordButton.addEventListener("click", startRecording);
      const voiceDownload = document.getElementById("voiceDownload");
      let mediaStream;
      let mediaRecorder;
      let chunks = [];

      async function startRecording() {
        try {
          mediaStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          mediaRecorder = new MediaRecorder(mediaStream);
          mediaRecorder.addEventListener("dataavailable", handleDataAvailable);
          mediaRecorder.start();
          recordButton.textContent = "در حال ضبط...";
        } catch (error) {
          console.error("خطا در دسترسی به دستگاه صوتی کاربر:", error);
        }
      }

      function handleDataAvailable(event) {
        chunks.push(event.data);
      }

      function saveRecording() {
        const blob = new Blob(chunks, { type: "audio/webm" });
        const downloadLink = document.createElement("a");
        downloadLink.href = URL.createObjectURL(blob);
        downloadLink.download = "recording.webm";
        voiceDownload.appendChild(downloadLink);
        downloadLink.click();
        recordButton.textContent = "ضبط صدا";
        chunks = [];
      }

      const saveButton = document.querySelector("#saveButton");
      saveButton.addEventListener("click", saveRecording);

    </script>
  </body>
</html>
